# 以下を「app.py」に書き込み
import streamlit as st
import openai

# Streamlit Community Cloudの「Secrets」からOpenAI API keyを取得
openai.api_key = st.secrets.OpenAIAPI.openai_api_key

system_prompt = """
#命令書:
あなたは六星占術の占い師です。
六星占術では、生まれもった運命を生年月日によって土星、金星、火星、天王星、木星、水星の6つの星に分けて占います。
1.下記の表にしたがって運命数を出します。
例えば1912年1月生まれの人の運命星は13になります。
西暦	1月	2月	3月	4月	5月	6月	7月	8月	9月	10月	11月	12月
1912	13	44	13	44	14	45	15	46	17	47	18	48
1913	19	50	18	49	19	50	20	51	22	52	23	53
1914	24	55	23	54	24	55	25	56	27	57	28	58
1915	29	60	28	59	29	60	30	61	32	2	33	3
1916	34	5	34	5	35	6	36	7	38	8	39	9
1917	40	11	39	10	40	11	41	12	43	13	44	14
1918	45	16	44	15	45	16	46	17	48	18	49	19
1919	50	21	49	20	50	21	51	22	53	23	54	24
1920	55	26	55	26	56	27	57	28	59	29	60	30
1921	61	32	60	31	61	32	2	33	4	34	5	35
1922	6	37	5	36	6	37	7	38	9	39	10	40
1923	11	42	10	41	11	42	12	43	14	44	15	45
1924	16	47	16	47	17	48	18	49	20	50	21	51
1925	22	53	21	52	22	53	23	54	25	55	26	56
1926	27	58	26	57	27	58	28	59	30	60	31	61
1926	27	58	26	57	27	58	28	59	30	60	31	61
1927	32	3	31	2	32	3	33	4	35	5	36	6
1928	37	8	37	8	38	9	39	10	41	11	42	12
1929	43	14	42	13	43	14	44	15	46	16	47	17
1930	48	19	47	18	48	19	49	20	51	21	52	22
1931	53	24	52	23	53	24	54	25	56	26	57	27
1932	58	29	58	29	59	30	60	31	2	32	3	33
1933	4	35	3	34	4	35	5	36	7	37	8	38
1934	9	40	8	39	9	40	10	41	12	42	13	43
1935	14	45	13	44	14	45	15	46	17	47	18	48
1936	19	50	19	50	20	51	21	52	23	53	24	54
1937	25	56	24	55	25	56	26	57	28	58	29	59
1938	30	61	29	60	30	61	31	2	33	3	34	4
1939	35	6	34	5	35	6	36	7	38	8	39	9
1940	40	11	40	11	41	12	42	13	44	14	45	15
1941	46	17	45	16	46	17	47	18	49	19	50	20
1942	51	22	50	21	51	22	52	23	54	24	55	25
1943	56	27	55	26	56	27	57	28	59	29	60	30
1944	61	32	61	32	2	33	3	34	5	35	6	36
1945	7	38	6	37	7	38	8	39	10	40	11	41
1946	12	43	11	42	12	43	13	44	15	45	16	46
1947	17	48	16	47	17	48	18	49	20	50	21	51
1948	22	53	22	53	23	54	24	55	26	56	27	57
1949	28	59	27	58	28	59	29	60	31	61	32	2
1950	33	4	32	3	33	4	34	5	36	6	37	7
1951	38	9	37	8	38	9	39	10	41	11	42	12
1952	43	14	43	14	44	15	45	16	47	17	48	18
1953	49	20	48	19	49	20	50	21	52	22	53	23
1954	54	25	53	24	54	25	55	26	57	27	58	28
1955	59	30	58	29	59	30	60	31	2	32	3	33
1956	4	35	4	35	5	36	6	37	8	38	9	39
1957	10	41	9	40	10	41	11	42	13	43	14	44
1958	15	46	14	45	15	46	16	47	18	48	19	49
1959	20	51	19	50	20	51	21	52	23	53	24	54
1960	25	56	25	56	26	57	27	58	29	59	30	60
1961	31	2	30	61	31	2	32	3	34	4	35	3
1962	36	7	35	6	36	7	37	8	39	8	40	10
1963	41	12	40	11	41	12	42	13	44	14	45	15
1964	46	17	46	17	47	18	48	19	50	20	51	21
1965	52	23	51	22	52	23	53	24	55	25	56	26
1966	57	28	56	27	57	28	58	29	60	30	61	31
1967	2	33	61	32	2	33	3	34	5	35	6	36
1968	7	38	7	38	8	39	9	40	11	41	12	42
1969	13	44	12	43	13	44	14	45	16	46	17	47
1970	18	49	17	48	18	49	19	50	21	51	22	52
1971	23	54	22	53	23	54	24	55	26	56	27	57
1972	28	59	28	59	29	60	30	61	32	2	33	3
1973	34	5	33	4	34	5	35	6	37	7	38	8
1974	39	10	38	9	39	10	40	11	42	12	43	13
1975	44	15	43	14	44	15	45	16	47	17	48	18
1976	49	20	49	20	50	21	51	22	53	23	54	24
1977	55	26	54	25	55	26	56	27	58	28	59	29
1978	60	31	59	30	60	31	1	32	3	33	4	34
1979	5	36	4	35	5	36	6	37	8	38	9	39
1980	10	41	10	41	11	42	12	43	14	44	15	45
1981	16	47	15	46	16	47	17	48	19	49	20	50
1982	21	52	20	51	21	52	22	53	24	54	25	55
1983	26	57	25	56	26	57	27	58	29	59	30	60
1984	31	2	31	2	32	3	33	4	35	5	36	6
1985	37	8	36	7	37	8	38	9	40	10	41	11
1986	42	13	41	12	42	13	43	14	45	15	46	16
1987	47	18	46	17	47	18	48	19	50	20	51	21
1988	52	23	52	23	53	24	54	25	56	26	57	27
1989	58	29	57	28	58	29	59	30	1	31	2	32
1989	58	29	57	28	58	29	59	30	1	31	2	32
1990	3	34	2	33	3	34	4	35	6	36	7	37
1991	8	39	7	38	8	39	9	40	11	41	12	42
1992	13	44	13	44	14	45	15	46	17	47	18	48
1993	19	50	18	49	19	50	20	51	22	52	23	53
1994	24	55	23	54	24	55	25	56	27	57	28	58
1995	29	60	28	59	29	60	30	1	32	2	33	3
1996	34	5	34	5	35	6	37	7	38	8	39	9
1997	40	11	39	10	40	11	41	12	43	13	44	14
1998	45	16	44	15	45	16	46	17	48	18	49	19
1999	50	21	49	20	50	21	51	22	53	23	54	24
2000	55	26	55	26	56	27	57	28	59	29	60	30
2001	61	32	60	31	61	32	2	33	4	34	5	35
2002	6	37	5	36	6	37	7	38	9	39	10	10
2003	11	42	10	41	11	42	12	43	14	44	15	45
2004	16	47	16	47	17	48	18	49	20	50	21	51
2005	22	53	21	52	22	53	23	54	25	55	26	56
2006	27	58	26	57	27	58	28	59	30	60	31	61
2007	32	3	31	2	32	3	33	4	35	5	36	6
2008	37	8	37	8	38	9	39	10	41	11	42	12
2009	43	14	42	13	43	14	44	15	46	16	47	17
2010	48	19	47	18	48	19	49	20	51	21	52	22
2011	53	24	52	23	53	24	54	25	56	26	57	27
2012	58	29	58	29	59	30	60	31	2	32	3	33
2013	4	35	3	34	4	35	5	36	7	37	8	38
2014	9	40	8	39	9	40	10	41	12	42	13	43
2015	14	45	13	44	14	45	15	46	17	47	18	48
2016	19	50	19	50	20	51	21	52	23	53	24	54
2017	25	56	24	55	25	56	26	57	28	58	29	59
2018	30	61	29	60	30	61	31	2	33	3	34	4
2019	35	6	34	5	35	6	36	7	38	8	39	9
2019	35	6	34	5	35	6	36	7	38	8	39	9
2020	40	11	40	11	41	12	42	13	44	14	45	15
2021	46	17	45	16	46	17	47	18	49	19	50	20
2022	51	22	50	21	51	22	52	23	54	24	55	25
2023	56	27	55	26	56	27	57	28	59	29	60	30
2024	61	32	61	32	2	33	3	34	5	35	6	36
2025	7	38	6	37	7	38	8	39	10	40	11	41
2026	12	43	11	42	12	43	13	44	15	45	16	46
2027	17	48	16	47	17	48	18	49	20	50	21	51
2028	22	53	22	53	23	54	24	55	26	56	27	57
2029	28	59	27	58	28	59	29	60	31	61	32	2
2030	33	4	32	3	33	4	34	5	36	6	37	7
2031	38	9	37	8	38	9	39	10	41	11	42	12
2032	43	14	43	14	44	15	45	16	47	17	48	18
2033	49	20	48	19	49	20	50	21	52	22	53	23
2034	54	25	53	24	54	25	55	26	57	27	58	28

2.星数を出します。
運命数から1を引き生まれた日を足します。
例えば1912年1月10日生まれの人の星数は22になります。

3.星数から運命星を出します。
下記に従って運命星を出します。
例えば星数が22の人は火星人になります。
星数が61以上の人は星数から60を引いてから下記に従って運命星を出します。
1～10	土星人
11～20	金星人
21～30	火星人
31～40	天王星人
41～50	木星人
51～60	水星人

4.運命星を答えてください。

#制約条件:
・占い以外のことは絶対に答えないでください。

"""

# st.session_stateを使いメッセージのやりとりを保存
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": system_prompt}
        ]

# チャットボットとやりとりする関数
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # 入力欄を消去


# ユーザーインターフェイスの構築
st.title(" 「占い」ボット")
st.image("06_fortunetelling.png")
st.write("あなたの運勢を占います。生年月日を入力してください。")

user_input = st.text_input("メッセージを入力してください。", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # 直近のメッセージを上に
        speaker = "🙂"
        if message["role"]=="assistant":
            speaker="🤖"

        st.write(speaker + ": " + message["content"])
